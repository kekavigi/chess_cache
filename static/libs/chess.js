function rootNode(t){return null!==t?{comment:t,variations:[]}:{variations:[]}}function node(t,e,i,r,s){let n={move:t,variations:s};return e&&(n.suffix=e),i&&(n.nag=i),null!==r&&(n.comment=r),n}function lineToTree(...t){let[e,...i]=t,r=e;for(let s of i)null!==s&&(r.variations=[s,...s.variations],s.variations=[],r=s);return e}function pgn(t,e){if(e.marker&&e.marker.comment){let i=e.root;for(;;){let r=i.variations[0];if(!r){i.comment=e.marker.comment;break}i=r}}return{headers:t,root:e.root,result:(e.marker&&e.marker.result)??void 0}}function peg$subclass(t,e){function i(){this.constructor=t}i.prototype=e.prototype,t.prototype=new i}function peg$SyntaxError(t,e,i,r){var s=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(s,peg$SyntaxError.prototype),s.expected=e,s.found=i,s.location=r,s.name="SyntaxError",s}function peg$padEnd(t,e,i){return(i=i||" ",t.length>e)?t:(e-=t.length,t+(i+=i.repeat(e)).slice(0,e))}function peg$parse(t,e){var i,r,s,n,o,a,h,l,$,u={},f=(e=void 0!==e?e:{}).grammarSource,c={pgn:tv},_=tv,p="O-O-O",g="0-0-0",d="1/2-1/2",S=/^[a-zA-Z]/,m=/^[^"]/,E=/^[0-9]/,b=/^[.]/,v=/^[a-zA-Z1-8\-=]/,A=/^[+#]/,T=/^[!?]/,I=/^[^}]/,O=/^[^\r\n]/,C=/^[ \t\r\n]/,N=tE("tag pair"),k=tS("[",!1),K=tS('"',!1),x=tS("]",!1),P=tE("tag name"),y=tm([["a","z"],["A","Z"]],!1,!1),L=tE("tag value"),B=tm(['"'],!0,!1),R=tE("move number"),M=tm([["0","9"]],!1,!1),w=tS(".",!1),F=tm(["."],!1,!1),D=tE("standard algebraic notation"),U=tS("O-O-O",!1),q=tS("O-O",!1),W=tS("0-0-0",!1),G=tS("0-0",!1),H=tm([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Q=tm(["+","#"],!1,!1),V=tE("suffix annotation"),Y=tm(["!","?"],!1,!1),j=tE("NAG"),z=tS("$",!1),Z=tE("brace comment"),J=tS("{",!1),X=tm(["}"],!0,!1),tt=tS("}",!1),te=tE("rest of line comment"),ti=tS(";",!1),tr=tm(["\r","\n"],!0,!1),ts=tE("variation"),tn=tS("(",!1),to=tS(")",!1),ta=tE("game termination marker"),th=tS("1-0",!1),tl=tS("0-1",!1),t$=tS("1/2-1/2",!1),tu=tS("*",!1),tf=tE("whitespace"),t8=tm([" ","	","\r","\n"],!1,!1),tc=0|e.peg$currPos,t_=[{line:1,column:1}],tp=tc,tg=e.peg$maxFailExpected||[],td=0|e.peg$silentFails;if(e.startRule){if(!(e.startRule in c))throw Error("Can't start parsing from rule \""+e.startRule+'".');_=c[e.startRule]}function tS(t,e){return{type:"literal",text:t,ignoreCase:e}}function tm(t,e,i){return{type:"class",parts:t,inverted:e,ignoreCase:i}}function tE(t){return{type:"other",description:t}}function tb(e){var i,r=t_[e];if(r)return r;if(e>=t_.length)i=t_.length-1;else for(i=e;!t_[--i];);for(r={line:(r=t_[i]).line,column:r.column};i<e;)10===t.charCodeAt(i)?(r.line++,r.column=1):r.column++,i++;return t_[e]=r,r}function t6(t){!(tc<tp)&&(tc>tp&&(tp=tc,tg=[]),tg.push(t))}function tv(){var e,i,r,s,n,o,a,h,l,$,f,c,_,p,g;return e=tc,i=function t(){var e,i,r,s;for(e=tc,i=[],r=tA();r!==u;)i.push(r),r=tA();return r=tk(),e=Object.fromEntries(s=i)}(),r=(o=tc,a=tT(),tk(),(h=((td++,f=tc,"1-0"===t.substr(tc,3)?(c="1-0",tc+=3):(c=u,0===td&&t6(th)),c===u&&("0-1"===t.substr(tc,3)?(c="0-1",tc+=3):(c=u,0===td&&t6(tl)),c===u&&(t.substr(tc,7)===d?(c=d,tc+=7):(c=u,0===td&&t6(t$)),c===u&&(42===t.charCodeAt(tc)?(c="*",tc++):(c=u,0===td&&t6(tu))))),c!==u)?(tk(),(_=tC())===u&&(_=null),f=(p=c,g=_,{result:p,comment:g})):(tc=f,f=u),td--,f===u&&(c=u,0===td&&t6(ta)),f))===u&&(h=null),tk(),o=(l=a,$=h,{root:l,marker:$})),e=(s=i,pgn(s,n=r))}function tA(){var e,i,r,s,n,o,a,h,l;return(td++,e=tc,tk(),91===t.charCodeAt(tc)?(i="[",tc++):(i=u,0===td&&t6(k)),i!==u&&(tk(),(r=function e(){var i,r,s;if(td++,i=tc,r=[],s=t.charAt(tc),S.test(s)?tc++:(s=u,0===td&&t6(y)),s!==u)for(;s!==u;)r.push(s),s=t.charAt(tc),S.test(s)?tc++:(s=u,0===td&&t6(y));else r=u;return i=r!==u?t.substring(i,tc):r,td--,i===u&&(r=u,0===td&&t6(P)),i}())!==u&&(tk(),34===t.charCodeAt(tc)?(s='"',tc++):(s=u,0===td&&t6(K)),s!==u&&(n=function e(){var i,r,s;for(td++,i=tc,r=[],s=t.charAt(tc),m.test(s)?tc++:(s=u,0===td&&t6(B));s!==u;)r.push(s),s=t.charAt(tc),m.test(s)?tc++:(s=u,0===td&&t6(B));return i=t.substring(i,tc),td--,r=u,0===td&&t6(L),i}(),34===t.charCodeAt(tc)?(o='"',tc++):(o=u,0===td&&t6(K)),o!==u&&(tk(),93===t.charCodeAt(tc)?(a="]",tc++):(a=u,0===td&&t6(x)),a!==u)))))?e=(h=r,[h,l=n]):(tc=e,e=u),td--,e===u&&0===td&&t6(N),e}function tT(){var t,e,i,r,s,n;for(t=tc,(e=tC())===u&&(e=null),i=[],r=tI();r!==u;)i.push(r),r=tI();return s=e,n=i,lineToTree(rootNode(s),...n.flat())}function tI(){var e,i,r,s,n,o,a,h,l,$,f,c,_;if(e=tc,tk(),function e(){var i,r,s,n,o,a;for(td++,i=tc,r=[],s=t.charAt(tc),E.test(s)?tc++:(s=u,0===td&&t6(M));s!==u;)r.push(s),s=t.charAt(tc),E.test(s)?tc++:(s=u,0===td&&t6(M));if(46===t.charCodeAt(tc)?(s=".",tc++):(s=u,0===td&&t6(w)),s!==u){for(n=tk(),o=[],a=t.charAt(tc),b.test(a)?tc++:(a=u,0===td&&t6(F));a!==u;)o.push(a),a=t.charAt(tc),b.test(a)?tc++:(a=u,0===td&&t6(F));i=r=[r,s,n,o]}else tc=i,i=u;return td--,i===u&&(r=u,0===td&&t6(R)),i}(),tk(),(i=function e(){var i,r,s,n,o,a;if(td++,i=tc,r=tc,t.substr(tc,5)===p?(s=p,tc+=5):(s=u,0===td&&t6(U)),s===u&&("O-O"===t.substr(tc,3)?(s="O-O",tc+=3):(s=u,0===td&&t6(q)),s===u&&(t.substr(tc,5)===g?(s=g,tc+=5):(s=u,0===td&&t6(W)),s===u&&("0-0"===t.substr(tc,3)?(s="0-0",tc+=3):(s=u,0===td&&t6(G)),s===u)))){if(s=tc,n=t.charAt(tc),S.test(n)?tc++:(n=u,0===td&&t6(y)),n!==u){if(o=[],a=t.charAt(tc),v.test(a)?tc++:(a=u,0===td&&t6(H)),a!==u)for(;a!==u;)o.push(a),a=t.charAt(tc),v.test(a)?tc++:(a=u,0===td&&t6(H));else o=u;o!==u?s=n=[n,o]:(tc=s,s=u)}else tc=s,s=u}return s!==u?(n=t.charAt(tc),A.test(n)?tc++:(n=u,0===td&&t6(Q)),n===u&&(n=null),r=s=[s,n]):(tc=r,r=u),i=r!==u?t.substring(i,tc):r,td--,i===u&&(r=u,0===td&&t6(D)),i}())!==u){for((r=function e(){var i,r,s;for(td++,i=tc,r=[],s=t.charAt(tc),T.test(s)?tc++:(s=u,0===td&&t6(Y));s!==u;)r.push(s),r.length>=2?s=u:(s=t.charAt(tc),T.test(s)?tc++:(s=u,0===td&&t6(Y)));return r.length<1?(tc=i,i=u):i=r,td--,i===u&&(r=u,0===td&&t6(V)),i}())===u&&(r=null),s=[],n=tO();n!==u;)s.push(n),n=tO();for(n=tk(),(o=tC())===u&&(o=null),a=[],h=tN();h!==u;)a.push(h),h=tN();e=(l=i,$=r,f=s,c=o,node(l,$,f,c,_=a))}else tc=e,e=u;return e}function tO(){var e,i,r,s,n,o;if(td++,e=tc,tk(),36===t.charCodeAt(tc)?(i="$",tc++):(i=u,0===td&&t6(z)),i!==u){if(r=tc,s=[],n=t.charAt(tc),E.test(n)?tc++:(n=u,0===td&&t6(M)),n!==u)for(;n!==u;)s.push(n),n=t.charAt(tc),E.test(n)?tc++:(n=u,0===td&&t6(M));else s=u;(r=s!==u?t.substring(r,tc):s)!==u?e=o=r:(tc=e,e=u)}else tc=e,e=u;return td--,e===u&&0===td&&t6(j),e}function tC(){var e;return(e=function e(){var i,r,s,n,o,a;if(td++,i=tc,123===t.charCodeAt(tc)?(r="{",tc++):(r=u,0===td&&t6(J)),r!==u){for(s=tc,n=[],o=t.charAt(tc),I.test(o)?tc++:(o=u,0===td&&t6(X));o!==u;)n.push(o),o=t.charAt(tc),I.test(o)?tc++:(o=u,0===td&&t6(X));(s=t.substring(s,tc),125===t.charCodeAt(tc)?(n="}",tc++):(n=u,0===td&&t6(tt)),n!==u)?i=(a=s).replace(/[\r\n]+/g," "):(tc=i,i=u)}else tc=i,i=u;return td--,i===u&&(r=u,0===td&&t6(Z)),i}())===u&&(e=function e(){var i,r,s,n,o,a;if(td++,i=tc,59===t.charCodeAt(tc)?(r=";",tc++):(r=u,0===td&&t6(ti)),r!==u){for(s=tc,n=[],o=t.charAt(tc),O.test(o)?tc++:(o=u,0===td&&t6(tr));o!==u;)n.push(o),o=t.charAt(tc),O.test(o)?tc++:(o=u,0===td&&t6(tr));i=(a=s=t.substring(s,tc)).trim()}else tc=i,i=u;return td--,i===u&&(r=u,0===td&&t6(te)),i}()),e}function tN(){var e,i,r,s,n;return(td++,e=tc,tk(),40===t.charCodeAt(tc)?(i="(",tc++):(i=u,0===td&&t6(tn)),i!==u&&(r=tT())!==u&&(tk(),41===t.charCodeAt(tc)?(s=")",tc++):(s=u,0===td&&t6(to)),s!==u))?e=n=r:(tc=e,e=u),td--,e===u&&0===td&&t6(ts),e}function tk(){var e,i;for(td++,e=[],i=t.charAt(tc),C.test(i)?tc++:(i=u,0===td&&t6(t8));i!==u;)e.push(i),i=t.charAt(tc),C.test(i)?tc++:(i=u,0===td&&t6(t8));return td--,i=u,0===td&&t6(tf),e}if($=_(),e.peg$library)return{peg$result:$,peg$currPos:tc,peg$FAILED:u,peg$maxFailExpected:tg,peg$maxFailPos:tp};if($!==u&&tc===t.length)return $;throw $!==u&&tc<t.length&&t6({type:"end"}),a=tg,h=tp<t.length?t.charAt(tp):null,l=(i=tp,r=tp<t.length?tp+1:tp,n=tb(i),o=tb(r),{source:f,start:{offset:i,line:n.line,column:n.column},end:{offset:r,line:o.line,column:o.column}}),new peg$SyntaxError(peg$SyntaxError.buildMessage(a,h),a,h,l)}peg$subclass(peg$SyntaxError,Error),peg$SyntaxError.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var i,r=null;for(i=0;i<t.length;i++)if(t[i].source===this.location.source){r=t[i].text.split(/\r\n|\n|\r/g);break}var s=this.location.start,n=this.location.source&&"function"==typeof this.location.source.offset?this.location.source.offset(s):s,o=this.location.source+":"+n.line+":"+n.column;if(r){var a=this.location.end,h=peg$padEnd("",n.line.toString().length," "),l=r[s.line-1],$=(s.line===a.line?a.column:l.length+1)-s.column||1;e+="\n --> "+o+"\n"+h+" |\n"+n.line+" | "+l+"\n"+h+" | "+peg$padEnd("",s.column-1," ")+peg$padEnd("",$,"^")}else e+="\n at "+o}return e},peg$SyntaxError.buildMessage=function(t,e){var i,r={literal:function(t){return'"'+n(t.text)+'"'},class:function(t){var e=t.parts.map(function(t){return Array.isArray(t)?o(t[0])+"-"+o(t[1]):o(t)});return"["+(t.inverted?"^":"")+e.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(t){return t.description}};function s(t){return t.charCodeAt(0).toString(16).toUpperCase()}function n(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+s(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+s(t)})}function o(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(t){return"\\x0"+s(t)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(t){return"\\x"+s(t)})}function a(t){return r[t.type](t)}return"Expected "+function t(e){var i,r,s=e.map(a);if(s.sort(),s.length>0){for(i=1,r=1;i<s.length;i++)s[i-1]!==s[i]&&(s[r]=s[i],r++);s.length=r}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(t)+" but "+((i=e)?'"'+n(i)+'"':"end of input")+" found."};/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */ let MASK64=0xffffffffffffffffn;function rotl(t,e){return(t<<e|t>>64n-e)&0xffffffffffffffffn}function wrappingMul(t,e){return t*e&0xffffffffffffffffn}function xoroshiro128(t){return function(){let e=BigInt(0xffffffffffffffffn&t),i=BigInt(t>>64n&0xffffffffffffffffn),r=wrappingMul(rotl(wrappingMul(e,5n),7n),9n);return i^=e,e=(rotl(e,24n)^i^i<<16n)&0xffffffffffffffffn,t=(i=rotl(i,37n))<<64n|e,r}}let rand=xoroshiro128(0xa187eb39cdcaed8f31c4b365b102e01en),PIECE_KEYS=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>rand()))),EP_KEYS=Array.from({length:8},()=>rand()),CASTLING_KEYS=Array.from({length:16},()=>rand()),SIDE_KEY=rand(),WHITE="w",BLACK="b",PAWN="p",KNIGHT="n",BISHOP="b",ROOK="r",QUEEN="q",KING="k",DEFAULT_POSITION="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class Move{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){let{color:i,piece:r,from:s,to:n,flags:o,captured:a,promotion:h}=e,l=algebraic(s),$=algebraic(n);for(let u in this.color=i,this.piece=r,this.from=l,this.to=$,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=l+$,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="",BITS)BITS[u]&o&&(this.flags+=FLAGS[u]);a&&(this.captured=a),h&&(this.promotion=h,this.lan+=h)}isCapture(){return this.flags.indexOf(FLAGS.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(FLAGS.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(FLAGS.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(FLAGS.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(FLAGS.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(FLAGS.BIG_PAWN)>-1}}let EMPTY=-1,FLAGS={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},SQUARES=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"],BITS={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},SEVEN_TAG_ROSTER={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},SUPLEMENTAL_TAGS={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},HEADER_TEMPLATE={...SEVEN_TAG_ROSTER,...SUPLEMENTAL_TAGS},Ox88={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},PAWN_OFFSETS={b:[16,32,17,15],w:[-16,-32,-17,-15]},PIECE_OFFSETS={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ATTACKS=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],RAYS=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],PIECE_MASKS={p:1,n:2,b:4,r:8,q:16,k:32},SYMBOLS="pnbrqkPNBRQK",PROMOTIONS=[KNIGHT,BISHOP,ROOK,QUEEN],RANK_1=7,RANK_2=6,RANK_7=1,RANK_8=0,SIDES={[KING]:BITS.KSIDE_CASTLE,[QUEEN]:BITS.QSIDE_CASTLE},ROOKS={w:[{square:Ox88.a1,flag:BITS.QSIDE_CASTLE},{square:Ox88.h1,flag:BITS.KSIDE_CASTLE},],b:[{square:Ox88.a8,flag:BITS.QSIDE_CASTLE},{square:Ox88.h8,flag:BITS.KSIDE_CASTLE},]},SECOND_RANK={b:1,w:6},SAN_NULLMOVE="--";function rank(t){return t>>4}function file(t){return 15&t}function isDigit(t){return -1!=="0123456789".indexOf(t)}function algebraic(t){let e=file(t),i=rank(t);return"abcdefgh".substring(e,e+1)+"87654321".substring(i,i+1)}function swapColor(t){return t===WHITE?BLACK:WHITE}function validateFen(t){let e=t.split(/\s+/);if(6!==e.length)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let i=parseInt(e[5],10);if(isNaN(i)||i<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let r=parseInt(e[4],10);if(isNaN(r)||r<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(e[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(e[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(e[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let s=e[0].split("/");if(8!==s.length)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let n=0;n<s.length;n++){let o=0,a=!1;for(let h=0;h<s[n].length;h++)if(isDigit(s[n][h])){if(a)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};o+=parseInt(s[n][h],10),a=!0}else{if(!/^[prnbqkPRNBQK]$/.test(s[n][h]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};o+=1,a=!1}if(8!==o)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if("3"==e[3][1]&&"w"==e[1]||"6"==e[3][1]&&"b"==e[1])return{ok:!1,error:"Invalid FEN: illegal en-passant square"};for(let{color:l,regex:$}of[{color:"white",regex:/K/g},{color:"black",regex:/k/g},]){if(!$.test(e[0]))return{ok:!1,error:`Invalid FEN: missing ${l} king`};if((e[0].match($)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${l} kings`}}return Array.from(s[0]+s[7]).some(t=>"P"===t.toUpperCase())?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function getDisambiguator(t,e){let i=t.from,r=t.to,s=t.piece,n=0,o=0,a=0;for(let h=0,l=e.length;h<l;h++){let $=e[h].from,u=e[h].to,f=e[h].piece;s===f&&i!==$&&r===u&&(n++,rank(i)===rank($)&&o++,file(i)===file($)&&a++)}return n>0?o>0&&a>0?algebraic(i):a>0?algebraic(i).charAt(1):algebraic(i).charAt(0):""}function addMove(t,e,i,r,s,n,o=BITS.NORMAL){let a=rank(r);if(s===PAWN&&(7===a||0===a))for(let h=0;h<PROMOTIONS.length;h++){let l=PROMOTIONS[h];t.push({color:e,from:i,to:r,piece:s,captured:n,promotion:l,flags:o|BITS.PROMOTION})}else t.push({color:e,from:i,to:r,piece:s,captured:n,flags:o})}function inferPieceType(t){let e=t.charAt(0);if(e>="a"&&e<="h"){let i=t.match(/[a-h]\d.*[a-h]\d/);if(i)return;return PAWN}return"o"===(e=e.toLowerCase())?KING:e}function strippedSan(t){return t.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Chess{_board=Array(128);_turn=WHITE;_header={};_kings={w:-1,b:-1};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=DEFAULT_POSITION,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=Array(128),this._kings={w:-1,b:-1},this._turn=WHITE,this._castling={w:0,b:0},this._epSquare=-1,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...HEADER_TEMPLATE},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:i=!1}={}){let r=t.split(/\s+/);if(r.length>=2&&r.length<6&&(t=r.concat(["-","-","0","1"].slice(-(6-r.length))).join(" ")),r=t.split(/\s+/),!e){let{ok:s,error:n}=validateFen(t);if(!s)throw Error(n)}let o=r[0],a=0;this.clear({preserveHeaders:i});for(let h=0;h<o.length;h++){let l=o.charAt(h);if("/"===l)a+=8;else if(isDigit(l))a+=parseInt(l,10);else{let $=l<"a"?WHITE:BLACK;this._put({type:l.toLowerCase(),color:$},algebraic(a)),a++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=BITS.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=BITS.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=BITS.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=BITS.QSIDE_CASTLE),this._epSquare="-"===r[3]?-1:Ox88[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,i="";for(let r=Ox88.a8;r<=Ox88.h1;r++){if(this._board[r]){e>0&&(i+=e,e=0);let{color:s,type:n}=this._board[r];i+=s===WHITE?n.toUpperCase():n.toLowerCase()}else e++;r+1&136&&(e>0&&(i+=e),r!==Ox88.h1&&(i+="/"),e=0,r+=8)}let o="";this._castling[WHITE]&BITS.KSIDE_CASTLE&&(o+="K"),this._castling[WHITE]&BITS.QSIDE_CASTLE&&(o+="Q"),this._castling[BLACK]&BITS.KSIDE_CASTLE&&(o+="k"),this._castling[BLACK]&BITS.QSIDE_CASTLE&&(o+="q"),o=o||"-";let a="-";if(-1!==this._epSquare){if(t)a=algebraic(this._epSquare);else{let h=this._epSquare+(this._turn===WHITE?16:-16);for(let l of[h+1,h-1]){if(136&l)continue;let $=this._turn;if(this._board[l]?.color===$&&this._board[l]?.type===PAWN){this._makeMove({color:$,from:l,to:this._epSquare,piece:PAWN,captured:PAWN,flags:BITS.EP_CAPTURE});let u=!this._isKingAttacked($);if(this._undoMove(),u){a=algebraic(this._epSquare);break}}}}}return[i,this._turn,o,a,this._halfMoves,this._moveNumber,].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;let{color:e,type:i}=this._board[t];return PIECE_KEYS[({w:0,b:1})[e]][({p:0,n:1,b:2,r:3,q:4,k:5})[i]][t]}_epKey(){return -1===this._epSquare?0n:EP_KEYS[7&this._epSquare]}_castlingKey(){let t=this._castling.w>>5|this._castling.b>>3;return CASTLING_KEYS[t]}_computeHash(){let t=0n;for(let e=Ox88.a8;e<=Ox88.h1;e++){if(136&e){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),"b"===this._turn&&(t^=SIDE_KEY),t}_updateSetup(t){this._history.length>0||(t!==DEFAULT_POSITION?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(DEFAULT_POSITION)}get(t){return this._board[Ox88[t]]}findPiece(t){let e=[];for(let i=Ox88.a8;i<=Ox88.h1;i++){if(136&i){i+=7;continue}this._board[i]&&this._board[i]?.color===t.color&&this._board[i].color===t.color&&this._board[i].type===t.type&&e.push(algebraic(i))}return e}put({type:t,color:e},i){return!!this._put({type:t,color:e},i)&&(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0)}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},i){if(-1==="pnbrqkPNBRQK".indexOf(t.toLowerCase())||!(i in Ox88))return!1;let r=Ox88[i];if(t==KING&&!(-1==this._kings[e]||this._kings[e]==r))return!1;let s=this._board[r];return s&&s.type===KING&&(this._kings[s.color]=-1),this._set(r,{type:t,color:e}),t===KING&&(this._kings[e]=r),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){let e=this.get(t);return this._clear(Ox88[t]),e&&e.type===KING&&(this._kings[e.color]=-1),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();let t=this._board[Ox88.e1]?.type===KING&&this._board[Ox88.e1]?.color===WHITE,e=this._board[Ox88.e8]?.type===KING&&this._board[Ox88.e8]?.color===BLACK;t&&this._board[Ox88.a1]?.type===ROOK&&this._board[Ox88.a1]?.color===WHITE||(this._castling.w&=-65),t&&this._board[Ox88.h1]?.type===ROOK&&this._board[Ox88.h1]?.color===WHITE||(this._castling.w&=-33),e&&this._board[Ox88.a8]?.type===ROOK&&this._board[Ox88.a8]?.color===BLACK||(this._castling.b&=-65),e&&this._board[Ox88.h8]?.type===ROOK&&this._board[Ox88.h8]?.color===BLACK||(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(-1===this._epSquare)return;let t=this._epSquare+(this._turn===WHITE?-16:16),e=this._epSquare+(this._turn===WHITE?16:-16);if(null!==this._board[t]||null!==this._board[this._epSquare]||this._board[e]?.color!==swapColor(this._turn)||this._board[e]?.type!==PAWN){this._hash^=this._epKey(),this._epSquare=-1;return}let i=t=>!(136&t)&&this._board[t]?.color===this._turn&&this._board[t]?.type===PAWN;[e+1,e-1].some(i)||(this._hash^=this._epKey(),this._epSquare=-1)}_attacked(t,e,i){let r=[];for(let s=Ox88.a8;s<=Ox88.h1;s++){if(136&s){s+=7;continue}if(void 0===this._board[s]||this._board[s].color!==t)continue;let n=this._board[s],o=s-e;if(0===o)continue;let a=o+119;if(ATTACKS[a]&PIECE_MASKS[n.type]){if(n.type===PAWN){if(o>0&&n.color===WHITE||o<=0&&n.color===BLACK){if(!i)return!0;r.push(algebraic(s))}continue}if("n"===n.type||"k"===n.type){if(!i)return!0;r.push(algebraic(s));continue}let h=RAYS[a],l=s+h,$=!1;for(;l!==e;){if(null!=this._board[l]){$=!0;break}l+=h}if(!$){if(!i)return!0;r.push(algebraic(s));continue}}}return!!i&&r}attackers(t,e){return e?this._attacked(e,Ox88[t],!0):this._attacked(this._turn,Ox88[t],!0)}_isKingAttacked(t){let e=this._kings[t];return -1!==e&&this._attacked(swapColor(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,Ox88[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&0===this._moves().length}isStalemate(){return!this.isCheck()&&0===this._moves().length}isInsufficientMaterial(){let t={b:0,n:0,r:0,q:0,k:0,p:0},e=[],i=0,r=0;for(let s=Ox88.a8;s<=Ox88.h1;s++){if(r=(r+1)%2,136&s){s+=7;continue}let n=this._board[s];n&&(t[n.type]=n.type in t?t[n.type]+1:1,n.type===BISHOP&&e.push(r),i++)}if(2===i||3===i&&(1===t[BISHOP]||1===t[KNIGHT]))return!0;if(i===t[BISHOP]+2){let o=0,a=e.length;for(let h=0;h<a;h++)o+=e[h];if(0===o||o===a)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e,piece:i}={}){let r=this._moves({square:e,piece:i});return t?r.map(t=>new Move(this,t)):r.map(t=>this._moveToSan(t,r))}_moves({legal:t=!0,piece:e,square:i}={}){let r=i?i.toLowerCase():void 0,s=e?.toLowerCase(),n=[],o=this._turn,a=swapColor(o),h=Ox88.a8,l=Ox88.h1,$=!1;if(r){if(!(r in Ox88))return[];h=l=Ox88[r],$=!0}for(let u=h;u<=l;u++){if(136&u){u+=7;continue}if(!this._board[u]||this._board[u].color===a)continue;let{type:f}=this._board[u],c;if(f===PAWN){if(s&&s!==f)continue;c=u+PAWN_OFFSETS[o][0],this._board[c]||(addMove(n,o,u,c,PAWN),c=u+PAWN_OFFSETS[o][1],SECOND_RANK[o]!==rank(u)||this._board[c]||addMove(n,o,u,c,PAWN,void 0,BITS.BIG_PAWN));for(let _=2;_<4;_++)136&(c=u+PAWN_OFFSETS[o][_])||(this._board[c]?.color===a?addMove(n,o,u,c,PAWN,this._board[c].type,BITS.CAPTURE):c===this._epSquare&&addMove(n,o,u,c,PAWN,PAWN,BITS.EP_CAPTURE))}else{if(s&&s!==f)continue;for(let p=0,g=PIECE_OFFSETS[f].length;p<g;p++){let d=PIECE_OFFSETS[f][p];for(c=u;!(136&(c+=d));){if(this._board[c]){if(this._board[c].color===o)break;addMove(n,o,u,c,f,this._board[c].type,BITS.CAPTURE);break}if(addMove(n,o,u,c,f),f===KNIGHT||f===KING)break}}}}if((void 0===s||s===KING)&&(!$||l===this._kings[o])){if(this._castling[o]&BITS.KSIDE_CASTLE){let S=this._kings[o],m=S+2;this._board[S+1]||this._board[m]||this._attacked(a,this._kings[o])||this._attacked(a,S+1)||this._attacked(a,m)||addMove(n,o,this._kings[o],m,KING,void 0,BITS.KSIDE_CASTLE)}if(this._castling[o]&BITS.QSIDE_CASTLE){let E=this._kings[o],b=E-2;this._board[E-1]||this._board[E-2]||this._board[E-3]||this._attacked(a,this._kings[o])||this._attacked(a,E-1)||this._attacked(a,b)||addMove(n,o,this._kings[o],b,KING,void 0,BITS.QSIDE_CASTLE)}}if(!t||-1===this._kings[o])return n;let v=[];for(let A=0,T=n.length;A<T;A++)this._makeMove(n[A]),this._isKingAttacked(o)||v.push(n[A]),this._undoMove();return v}move(t,{strict:e=!1}={}){let i=null;if("string"==typeof t)i=this._moveFromSan(t,e);else if(null===t)i=this._moveFromSan("--",e);else if("object"==typeof t){let r=this._moves();for(let s=0,n=r.length;s<n;s++)if(t.from===algebraic(r[s].from)&&t.to===algebraic(r[s].to)&&(!("promotion"in r[s])||t.promotion===r[s].promotion)){i=r[s];break}}if(!i){if("string"==typeof t)throw Error(`Invalid move: ${t}`);throw Error(`Invalid move: ${JSON.stringify(t)}`)}if(this.isCheck()&&i.flags&BITS.NULL_MOVE)throw Error("Null move not allowed when in check");let o=new Move(this,i);return this._makeMove(i),this._incPositionCount(),o}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){let e=this._turn,i=swapColor(e);if(this._push(t),t.flags&BITS.NULL_MOVE){e===BLACK&&this._moveNumber++,this._halfMoves++,this._turn=i,this._epSquare=-1;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&BITS.EP_CAPTURE&&(this._turn===BLACK?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===KING){if(this._kings[e]=t.to,t.flags&BITS.KSIDE_CASTLE){let r=t.to-1,s=t.to+1;this._movePiece(s,r)}else if(t.flags&BITS.QSIDE_CASTLE){let n=t.to+1,o=t.to-2;this._movePiece(o,n)}this._castling[e]=0}if(this._castling[e]){for(let a=0,h=ROOKS[e].length;a<h;a++)if(t.from===ROOKS[e][a].square&&this._castling[e]&ROOKS[e][a].flag){this._castling[e]^=ROOKS[e][a].flag;break}}if(this._castling[i]){for(let l=0,$=ROOKS[i].length;l<$;l++)if(t.to===ROOKS[i][l].square&&this._castling[i]&ROOKS[i][l].flag){this._castling[i]^=ROOKS[i][l].flag;break}}if(this._hash^=this._castlingKey(),t.flags&BITS.BIG_PAWN){let u;u=e===BLACK?t.to-16:t.to+16,(t.to-1&136||this._board[t.to-1]?.type!==PAWN||this._board[t.to-1]?.color!==i)&&(t.to+1&136||this._board[t.to+1]?.type!==PAWN||this._board[t.to+1]?.color!==i)?this._epSquare=-1:(this._epSquare=u,this._hash^=this._epKey())}else this._epSquare=-1;t.piece===PAWN?this._halfMoves=0:t.flags&(BITS.CAPTURE|BITS.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===BLACK&&this._moveNumber++,this._turn=i,this._hash^=SIDE_KEY}undo(){let t=this._hash,e=this._undoMove();if(e){let i=new Move(this,e);return this._decPositionCount(t),i}return null}_undoMove(){let t=this._history.pop();if(void 0===t)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=SIDE_KEY;let i=this._turn,r=swapColor(i);if(e.flags&BITS.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:i})),e.captured){if(e.flags&BITS.EP_CAPTURE){let s;s=i===BLACK?e.to-16:e.to+16,this._set(s,{type:PAWN,color:r})}else this._set(e.to,{type:e.captured,color:r})}if(e.flags&(BITS.KSIDE_CASTLE|BITS.QSIDE_CASTLE)){let n,o;e.flags&BITS.KSIDE_CASTLE?(n=e.to+1,o=e.to-1):(n=e.to-2,o=e.to+1),this._movePiece(o,n)}return e}pgn({newline:t="\n",maxWidth:e=0}={}){let i=[],r=!1;for(let s in this._header){let n=this._header[s];n&&i.push(`[${s} "${this._header[s]}"]`+t),r=!0}r&&this._history.length&&i.push(t);let o=t=>{let e=this._comments[this.fen()];if(void 0!==e){let i=t.length>0?" ":"";t=`${t}${i}{${e}}`}return t},a=[];for(;this._history.length>0;)a.push(this._undoMove());let h=[],l="";for(0===a.length&&h.push(o(""));a.length>0;){l=o(l);let $=a.pop();if(!$)break;if(this._history.length||"b"!==$.color)"w"===$.color&&(l.length&&h.push(l),l=this._moveNumber+".");else{let u=`${this._moveNumber}. ...`;l=l?`${l} ${u}`:u}l=l+" "+this._moveToSan($,this._moves({legal:!0})),this._makeMove($)}if(l.length&&h.push(o(l)),h.push(this._header.Result||"*"),0===e)return i.join("")+h.join(" ");let f=function(){return i.length>0&&" "===i[i.length-1]&&(i.pop(),!0)},c=0;for(let _=0;_<h.length;_++){if(c+h[_].length>e&&h[_].includes("{")){c=function(r,s){for(let n of s.split(" "))if(n){if(r+n.length>e){for(;f();)r--;i.push(t),r=0}i.push(n),r+=n.length,i.push(" "),r++}return f()&&r--,r}(c,h[_]);continue}c+h[_].length>e&&0!==_?(" "===i[i.length-1]&&i.pop(),i.push(t),c=0):0!==_&&(i.push(" "),c++),i.push(h[_]),c+=h[_].length}return i.join("")}header(...t){for(let e=0;e<t.length;e+=2)"string"==typeof t[e]&&"string"==typeof t[e+1]&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??SEVEN_TAG_ROSTER[t]??null,this.getHeaders()}removeHeader(t){return t in this._header&&(this._header[t]=SEVEN_TAG_ROSTER[t]||null,!0)}getHeaders(){let t={};for(let[e,i]of Object.entries(this._header))null!==i&&(t[e]=i);return t}loadPgn(t,{strict:e=!1,newlineChar:i="\r?\n"}={}){"\r?\n"!==i&&(t=t.replace(RegExp(i,"g"),"\n"));let r=peg$parse(t);this.reset();let s=r.headers,n="";for(let o in s)"fen"===o.toLowerCase()&&(n=s[o]),this.header(o,s[o]);if(e){if("1"===s.SetUp){if(!("FEN"in s))throw Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(s.FEN,{preserveHeaders:!0})}}else n&&this.load(n,{preserveHeaders:!0});let a=r.root;for(;a;){if(a.move){let h=this._moveFromSan(a.move,e);if(null==h)throw Error(`Invalid move in PGN: ${a.move}`);this._makeMove(h),this._incPositionCount()}void 0!==a.comment&&(this._comments[this.fen()]=a.comment),a=a.variations[0]}let l=r.result;l&&Object.keys(this._header).length&&this._header.Result!==l&&this.setHeader("Result",l)}_moveToSan(t,e){let i="";if(t.flags&BITS.KSIDE_CASTLE)i="O-O";else if(t.flags&BITS.QSIDE_CASTLE)i="O-O-O";else{if(t.flags&BITS.NULL_MOVE)return"--";if(t.piece!==PAWN){let r=getDisambiguator(t,e);i+=t.piece.toUpperCase()+r}t.flags&(BITS.CAPTURE|BITS.EP_CAPTURE)&&(t.piece===PAWN&&(i+=algebraic(t.from)[0]),i+="x"),i+=algebraic(t.to),t.promotion&&(i+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?i+="#":i+="+"),this._undoMove(),i}_moveFromSan(t,e=!1){let i=strippedSan(t);if(e||("0-0"===i?i="O-O":"0-0-0"!==i||(i="O-O-O")),"--"==i){let r={color:this._turn,from:0,to:0,piece:"k",flags:BITS.NULL_MOVE};return r}let s=inferPieceType(i),n=this._moves({legal:!0,piece:s});for(let o=0,a=n.length;o<a;o++)if(i===strippedSan(this._moveToSan(n[o],n)))return n[o];if(e)return null;let h,l,$,u,f,c=!1;if((l=i.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/))?(h=l[1],$=l[2],u=l[3],f=l[4],1==$.length&&(c=!0)):(l=i.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/))&&(h=l[1],$=l[2],u=l[3],f=l[4],1==$.length&&(c=!0)),s=inferPieceType(i),n=this._moves({legal:!0,piece:h||s}),!u)return null;for(let _=0,p=n.length;_<p;_++)if($){if((!h||h.toLowerCase()==n[_].piece)&&Ox88[$]==n[_].from&&Ox88[u]==n[_].to&&(!f||f.toLowerCase()==n[_].promotion))return n[_];if(c){let g=algebraic(n[_].from);if((!h||h.toLowerCase()==n[_].piece)&&Ox88[u]==n[_].to&&($==g[0]||$==g[1])&&(!f||f.toLowerCase()==n[_].promotion))return n[_]}}else if(i===strippedSan(this._moveToSan(n[_],n)).replace("x",""))return n[_];return null}ascii(){let t="   +------------------------+\n";for(let e=Ox88.a8;e<=Ox88.h1;e++){if(0===file(e)&&(t+=" "+"87654321"[rank(e)]+" |"),this._board[e]){let i=this._board[e].type,r=this._board[e].color,s=r===WHITE?i.toUpperCase():i.toLowerCase();t+=" "+s+" "}else t+=" . ";e+1&136&&(t+="|\n",e+=8)}return t+="   +------------------------+\n",t+="     a  b  c  d  e  f  g  h"}perft(t){let e=this._moves({legal:!1}),i=0,r=this._turn;for(let s=0,n=e.length;s<n;s++)this._makeMove(e[s]),!this._isKingAttacked(r)&&(t-1>0?i+=this.perft(t-1):i++),this._undoMove();return i}setTurn(t){return this._turn!=t&&(this.move("--"),!0)}turn(){return this._turn}board(){let t=[],e=[];for(let i=Ox88.a8;i<=Ox88.h1;i++)null==this._board[i]?e.push(null):e.push({square:algebraic(i),type:this._board[i].type,color:this._board[i].color}),i+1&136&&(t.push(e),e=[],i+=8);return t}squareColor(t){if(t in Ox88){let e=Ox88[t];return(rank(e)+file(e))%2==0?"light":"dark"}return null}history({verbose:t=!1}={}){let e=[],i=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){let r=e.pop();if(!r)break;t?i.push(new Move(this,r)):i.push(this._moveToSan(r,this._moves())),this._makeMove(r)}return i}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){let e=this._positionCount.get(t)??0;1===e?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){let t=[],e={},i=t=>{t in this._comments&&(e[t]=this._comments[t])};for(;this._history.length>0;)t.push(this._undoMove());for(i(this.fen());;){let r=t.pop();if(!r)break;this._makeMove(r),i(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{let e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(let i of[KING,QUEEN])void 0!==e[i]&&(e[i]?this._castling[t]|=SIDES[i]:this._castling[t]&=~SIDES[i]);this._updateCastlingRights();let r=this.getCastlingRights(t);return(void 0===e[KING]||e[KING]===r[KING])&&(void 0===e[QUEEN]||e[QUEEN]===r[QUEEN])}getCastlingRights(t){return{[KING]:(this._castling[t]&SIDES[KING])!=0,[QUEEN]:(this._castling[t]&SIDES[QUEEN])!=0}}moveNumber(){return this._moveNumber}}export{BISHOP,BLACK,Chess,DEFAULT_POSITION,KING,KNIGHT,Move,PAWN,QUEEN,ROOK,SEVEN_TAG_ROSTER,SQUARES,WHITE,validateFen,xoroshiro128};